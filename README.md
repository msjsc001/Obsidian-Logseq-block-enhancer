# Obsidian Logseq 块引用增强插件

一个旨在将 Logseq 强大的块引用能力带入 Obsidian 的插件。

本项目提供了一套健壮的后台系统和编辑器工具，用于在 Obsidian 中处理 Logseq 风格的 `((...))` 块引用。

---

> **⚠️ 重要：当前状态与已知问题**
>
> **请注意：** 尽管本插件成功实现了一系列强大的后台和编辑器功能（详见下文），但其核心的**块引用可视化渲染功能**（在“实时预览”和“阅读”两种模式下显示块内容）**目前未能成功实现**。我们遇到了一个与 Obsidian 编辑器 API 相关的深层技术瓶颈，导致最终的渲染步骤无法被执行。详细的技术分析已记录在文档末尾的“致开发者”部分。

---

## ✅ 可用功能

尽管渲染功能缺失，本插件依然提供了一套功能完整且非常有价值的工具：

- **健壮的索引引擎**:
    - **全库扫描**: 自动扫描您的整个库，解析并索引所有 Logseq 风格的块、ID 和层级关系。
    - **增量更新**: 实时监控文件变动，并高效地更新索引。
    - **持久化缓存**: 索引被缓存在本地，实现 Obsidian 的近乎秒级的启动速度。

- **编辑器命令与自动补全**:
    - **复制块引用**: 使用“复制当前块的 Logseq 引用”命令，可以智能地为任何块创建 `((UUID))` 引用，为未来做好准备。
    - **块自动补全**: 只需在编辑器中输入 `((`，即可触发一个强大的搜索弹窗，在您的整个库中查找并插入任何块的引用。

## 安装指南

#### 1. 构建插件

本项目包含需要被编译成可用插件的源代码。

1.  **安装依赖**: 在本项目的根目录下打开终端，并运行 `npm install` 命令。
2.  **构建**: 运行 `npm run build` 命令。这将会创建最终所需的 `main.js` 文件。

#### 2. 在 Obsidian 中安装

1.  进入您 Obsidian 库的插件目录：`.obsidian/plugins/`。
2.  创建一个名为 `logseq-block-ref-enhancer` 的新文件夹。
3.  将本项目根目录下的 `main.js`, `manifest.json`, 和 `styles.css` 这三个文件复制到刚刚创建的 `logseq-block-ref-enhancer` 文件夹中。
4.  重启 Obsidian，进入 `设置` > `第三方插件`，然后启用“Logseq Block Ref Enhancer”插件。

## 使用方法

安装并启用后，以下功能即可使用。

#### 复制块引用命令
1.  将光标放在任何以 `- ` 开头的行（即一个块）上。
2.  打开命令面板 (`Ctrl/Cmd + P`)。
3.  搜索并执行 “**Copy current block's Logseq reference**” (复制当前块的 Logseq 引用) 命令。
4.  `((UUID))` 格式的引用会被复制到您的剪贴板。如果该块没有 ID，插件会自动为您添加一个。

#### 自动补全
1.  在编辑器中，输入 `((`。
2.  一个搜索弹窗将会出现。开始输入关键词以按内容筛选块。
3.  使用方向键和 `回车键` 来选择并插入块引用。

---

## 致开发者：瓶颈分析与项目结构

渲染功能的核心瓶颈在于：我们通过 `registerEditorExtension` 注册的 CodeMirror 6 `ViewPlugin`，由于未知原因，未被 Obsidian 的“实时预览”模式执行。我们已经排除了数据问题、时序问题和多个已知的编码错误。我们推断问题源于一个未在文档中说明的 API 行为、环境冲突或一个深层的构建问题。未来的开发者需要使用更底层的调试工具（例如在 Electron 中设置断点）来进一步追踪。

#### 项目文件结构
```
.
├── src/                      # 插件源代码
│   ├── editor/
│   │   ├── BlockSuggest.ts       # ✅ [正常工作] 实现 `((` 自动补全
│   │   ├── cm6-widget.ts         # ❗ [未被调用] “实时预览”的渲染小部件
│   │   └── LivePreviewExtension.ts # ❗ [未被调用] 核心症结所在，注册CM6渲染逻辑
│   ├── rendering/
│   │   └── LiveRenderer.ts       # ❗ [未被调用] “阅读模式”的渲染器
│   ├── services/
│   │   ├── BlockParser.ts        # ✅ [正常工作] Markdown块解析器
│   │   └── IndexService.ts       # ✅ [正常工作] 索引、缓存和文件监控服务
│   ├── types.ts                  # ✅ [正常工作] TypeScript类型定义
│   └── main.ts                   # ✅ [正常工作] 插件主入口
├── main.js                       # (由 `npm run build` 生成) 最终的插件文件
├── manifest.json                 # Obsidian 插件清单
├── package.json                  # 项目依赖与脚本
└── styles.css                    # 插件的 CSS 样式